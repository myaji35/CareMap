# CareMap 워크플로우 가이드

## 완전한 사용 흐름

CareMap 시스템을 처음부터 끝까지 사용하는 방법을 단계별로 설명합니다.

---

## 1단계: 개발 서버 시작

```bash
npm run dev
```

서버가 http://localhost:3000 에서 실행됩니다.

---

## 2단계: 크롤링 실행 (데이터 수집)

### 2-1. 관리자 페이지 접속
브라우저에서 http://localhost:3000/admin 접속

### 2-2. 크롤링 준비
1. 크롤링 목록에서 **"실행"** 버튼 클릭
2. 전체 페이지 수 확인 대기 (10-20초 소요)
3. "전체 XXX페이지 준비되었습니다!" 메시지 확인
4. **"OK - 시작"** 버튼 클릭

### 2-3. 크롤링 진행 확인
- 백그라운드에서 자동 실행
- 실시간 진행률 확인 (예: 5/10 페이지 50%)
- 프로그레스 바로 시각적 확인
- 페이지 새로고침/닫기 가능 (계속 실행됨)

### 2-4. 크롤링 완료 대기
- 상태가 "running" → "completed"로 변경
- 수집 개수 확인 (예: 100개 수집)
- 결과 카드에 상세 정보 표시

### 결과 예시:
```
상태: completed
수집: 100개
시작: 2025-10-22 09:00:00
완료: 2025-10-22 09:05:00
소요: 5분
```

---

## 3단계: 데이터베이스 저장

크롤링이 완료되면 데이터를 DB에 저장해야 합니다.

### 방법 1: 자동 저장 (권장)
크롤링 완료 시 자동으로 DB에 저장됩니다.
- ✅ "DB 저장 완료" 배지 확인

### 방법 2: 수동 저장
만약 자동 저장이 안 되었다면:
1. 크롤링 결과에서 **"데이터 가져오기"** 버튼 클릭
2. 저장 진행 확인
3. 저장 완료 후 결과 확인:
   - 신규: XX개
   - 업데이트: XX개
   - 실패: XX개

---

## 4단계: 좌표 데이터 입력 (지도 표시를 위해 필수!)

크롤링된 데이터는 주소만 있고 위도/경도가 없습니다.
지도에 표시하려면 **좌표를 반드시 입력**해야 합니다.

### 4-1. DB 관리 페이지 접속
사이드바에서 **"DB 관리"** 메뉴 클릭
또는 http://localhost:3000/admin/database 직접 접속

### 4-2. 데이터베이스 상태 확인
```
총 기관 수: 100개
좌표 설정 완료: 0개 (0%)
좌표 미설정: 100개
```

### 4-3. 좌표 일괄 업데이트
**세 가지 옵션:**
- **50개 업데이트**: 50개씩 처리 (추천: 첫 테스트)
- **100개 업데이트**: 100개씩 처리
- **전체 업데이트**: 모든 기관 처리 (시간 오래 걸림)

**"50개 업데이트"** 버튼 클릭

### 4-4. 업데이트 진행
```
✓ 좌표 업데이트 시작: 50개 기관
→ 진행률: 10/50 (20%)
→ 진행률: 20/50 (40%)
...
✓ 좌표 업데이트 완료!
  - 성공: 48개
  - 실패: 2개
  - 총 처리: 50개
```

### 4-5. 결과 확인
업데이트 결과가 화면에 표시됩니다:
```
✓ 48개 기관 좌표 업데이트 완료 (2개 실패)

성공: 48개 | 실패: 2개 | 총: 50개

오류 목록:
• 서울요양원: Geocoding 실패
• 부산돌봄센터: Geocoding 실패
```

### 4-6. 상태 재확인
**"새로고침"** 버튼을 눌러 최신 상태 확인:
```
총 기관 수: 100개
좌표 설정 완료: 48개 (48%)
좌표 미설정: 52개
```

### 4-7. 나머지 좌표 업데이트
필요하다면 **"전체 업데이트"** 버튼으로 나머지도 처리

---

## 5단계: 지도 뷰에서 확인

이제 좌표가 입력된 기관들을 지도에서 볼 수 있습니다!

### 5-1. 지도 뷰 접속
사이드바에서 **"지도 뷰"** 메뉴 클릭
또는 http://localhost:3000/dashboard/map-view 직접 접속

### 5-2. 지도 확인
- **파이차트 마커**: 각 기관의 정원/현원 비율 표시
  - 파란색: 정상 입소율
  - 빨간색: 정원 초과
  - 마커 안 숫자: 현원/정원
- **줌 레벨**에 따라 다르게 표시:
  - 레벨 13-11: 광역시/도 단위 클러스터
  - 레벨 10-8: 시/군/구 단위 클러스터
  - 레벨 7 이하: 개별 파이차트 마커

### 5-3. 기관 상세 정보
- 마커에 마우스 오버 → 팝업 표시
  - 기관명
  - 주소
  - 서비스 유형
  - 정원/현원
- **"이력 보기"** 버튼 클릭 → 월별 변경 이력 차트

### 5-4. 지역 선택 (우측 패널)
- 시/도 선택 → 해당 지역으로 이동
- 시/군/구 선택 → 더 상세한 지역으로 이동
- 빠른 지역 검색 가능

---

## 전체 워크플로우 요약

```
1. 개발 서버 시작
   npm run dev

2. 크롤링 실행
   /admin → "실행" → OK → 완료 대기

3. DB 저장 (자동)
   ✓ "DB 저장 완료" 확인

4. 좌표 입력 ⭐ 중요!
   /admin/database → "50개 업데이트" → 완료 확인

5. 지도 확인
   /dashboard/map-view → 마커 확인 → 이력 보기
```

---

## 주요 페이지 URL

| 페이지 | URL | 설명 |
|--------|-----|------|
| 메인 대시보드 | `/dashboard` | 전체 통계 및 현황 |
| 지도 뷰 | `/dashboard/map-view` | 기관 위치 시각화 |
| 크롤러 관리 | `/admin` | 데이터 수집 |
| DB 관리 | `/admin/database` | 좌표 업데이트 |

---

## 데이터 흐름

```
크롤링 실행
    ↓
웹사이트에서 데이터 수집 (기관명, 주소, 정원, 현원 등)
    ↓
DB에 저장 (Institution 테이블)
    ↓
Kakao Geocoding API 호출 (주소 → 위도/경도)
    ↓
좌표 업데이트 (latitude, longitude)
    ↓
지도 뷰에서 마커 표시
```

---

## 문제 해결

### Q1: 지도에 마커가 안 보여요
**A:** 좌표 데이터가 입력되지 않았습니다.
- `/admin/database`에서 좌표 업데이트 실행
- "좌표 설정 완료" 개수 확인

### Q2: 크롤링이 너무 느려요
**A:** 정상입니다.
- 페이지당 약 3-5초 소요
- 100페이지 = 약 5-8분
- 백그라운드 실행되므로 페이지 닫아도 됨

### Q3: 좌표 업데이트가 실패해요
**A:** Kakao API 제한 또는 잘못된 주소입니다.
- Rate Limiting: 100ms 지연 자동 적용
- 실패한 주소는 오류 목록에 표시
- 나중에 수동으로 재시도 가능

### Q4: 크롤링 상태가 멈췄어요
**A:** 상태 초기화 필요
- 5분 이상 업데이트 없으면 자동 초기화
- 또는 "상태 초기화" 버튼 클릭

---

## 다음 단계

시스템이 정상 작동하면:
- [ ] 정기 크롤링 스케줄 설정 (월 1회)
- [ ] 이력 관리 강화 (변경 감지 자동 백업)
- [ ] 사용자 인증 시스템 추가
- [ ] Vercel 배포 (Production)

---

## 기술 스택

- **Frontend**: Next.js 15, React 19, TypeScript
- **Database**: SQLite (dev) / Neon.tech (production)
- **ORM**: Prisma
- **Crawler**: Playwright (Chromium)
- **Maps**: Kakao Maps API
- **Geocoding**: Kakao REST API

---

## 참고 문서

- [프로젝트 PRD](./prd.md) - 요구사항 정의
- [개발 가이드](./CLAUDE.md) - 기술 문서
- [Admin 가이드](./src/app/admin/CLAUDE.md) - 크롤러 상세
- [Map View 가이드](./src/app/dashboard/map-view/CLAUDE.md) - 지도 기능

---

**마지막 업데이트**: 2025-10-22
